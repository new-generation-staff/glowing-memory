# 分布式全局ID生成
> 


---

### 一、分布式全局ID要求
```markdown
- 全局ID设计时要考虑的因素

1. 全局唯一：ID必须是全局唯一的
2. 高性能：高可用低延时，响应要快。不能成为业务瓶颈
3. 高可用：无限接近于100%可用
4. 好接入：在系统设计和实现上要尽可能的简单
5. 趋势递增：根据业务要求
```

### 二、`Sonwflake`实现方案
```markdown
sonwflake是twitter开源的分布式ID生成方案。共64位(Long类型的长度)，由1位符号位，41位时间戳(单位: 毫秒级)，10位工作机器ID，12位序列号构成。
1位符号位：一般正数为 0
41位时间戳：可以使用69年
10位工作机器ID由：5位datacenterId(数据中心)和5位workerId(机器ID)组成，支持部署1024个节点
12位序列号：支持每个节点每毫秒产生4096个ID
   
- 问题：
1. 时钟回拨：如果主机时间回拨，会造成重复ID
2. ID只能做到趋势递增，不能实现连续自增

- 时钟回拨问题优化方案：
1. 如果发现当前时间少于上次生成id的时间(时间回拨)，着计算回拨的时间差
2. 如果时间差(offset)小于等于5ms，着等待 offset * 2 的时间再生成
3. 如果offset大于5，则直接抛出异常

- sonwflake机器ID与数据中心ID
1. 可以通知配置文件手动指定配置
2. 默认可以根据不同机器所在服务器生成
3. 服务规模大，可以采用第三方组件进行自动配置

```

### 三、`Uid-generator`百度实现方案
```markdown
uid-generator是由百度开源的分布式ID解决方案，也是基于sonwflake实现的。支持自定义时间戳、机器ID、序列号的位数，且支持用于自定义workId的位数和初始化生成策略。
uid-generator也是64位，由1位符号位，28位时间戳(单位是：秒)，22位机器ID,13位序列号
1位符号位：一般正数为 0
28位时间戳：当前时间相对于时间基点"2016-05-20"的增量值；单位：秒
22位机器ID：内置默认实现由数据库分配，分配策略为：用后即弃
13位序列号：支持每秒8192个并发ID生成

uid-generator可以自定义workId的生产策略，默认提供的策略是：启动时由数据库分配。
应用启动时，会往数据库(WORKER_NODE)表中插入一条记录，插入成功后返回的自增id就是该机器的workId，而数据有host和port组成。

```



### 九、项目整合接入
```markdown
1. 提供轻量 uid-starter，和统一接口IdService。根据不同环境实现不同的生成策略：LocalIdService、RemoteIdService
   项目启动时，根据环境变量来判断使用哪种生产方案。默认开发环境使用sonwflake，测试生产环境使用uid-generator
   通过实现ImportSelector接口和EnvironmentAware接口，来判断当前的环境和使用的生成策略。

2. 提供单个ID获取和批量ID获取两个接口

3. eip-uid-ms作为微服务部署提供支持。远程服务ID生成策略采用百度开源uid-generator方案，也是基于sonwfkake。支持自定义时间戳、workId、序列号等位数。  
   同时支持自定义workId的生产策略，默认采用数据库方式，需要新建数据表WORKER_NODE表；在系统启动时会插入一条记录，插入成功后返回的自增Id就是该机器的workdId。
   同一个应用每重启一次就会消费一个workId
```