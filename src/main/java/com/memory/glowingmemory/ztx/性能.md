# 项目经验
> 线上系统突然运行缓慢，如果该问题导致线上系统不可用。首先要做的就是到处jstack和内存信息，然后重启系统，尽快保证系统可用性。然后分析堆栈信息定位问题
```markdown
一般有以下2种情况会导致系统运行突然变慢
1. 代码中某个位置读取数据量较大，导致系统内存耗尽，从而导致频繁GC，系统运行缓慢。
2. 代码中有比较cpu的操作，导致cpu过高，系统运行缓慢。
```

### 一、`Cpu`飙高的排查思路
> Cpu飙高肯定是有进程疯狂的在占用Cpu资源


- 排查步骤

1. 通过top命令查看占用cpu比较高的进程ID。
```bash
[root@localhost ~]# 
[root@localhost ~]# top
top - 14:07:24 up 43 days, 16:08,  2 users,  load average: 0.07, 0.08, 0.07
Tasks: 229 total,   1 running, 228 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.6 us,  0.6 sy,  0.0 ni, 98.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  8009268 total,  1261840 free,  3667052 used,  3080376 buff/cache
KiB Swap: 16777212 total, 16777212 free,        0 used.  3585860 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                              
24977 root      20   0 5724288 810912  13104 S   1.3 10.1  98:38.52 java                                                                                                                 
  371 root      20   0   63928  13788   1476 S   1.0  0.2 545:55.91 plymouthd                                                                                                            
28013 root      20   0 5869100   1.1g  13220 S   1.0 14.9  74:59.03 java                                                                                                                 
 2385 root      20   0  162148   2416   1580 R   0.3  0.0   0:00.02 top  
```

2. 找到消耗cpu最大的进程ID 如：24977，查看这个进程执行什么任务
```bash
[root@localhost ~]# ps -ef|grep 24977
root      2438 28198  0 14:09 pts/1    00:00:00 grep --color=auto 24977
root     24977 24961  2 Sep15 ?        01:38:40 java -jar /app.jar --spring.cloud.nacos.discovery.ip=192.168.207.240 --spring.profiles.active=st1030
root     28297 28253  0 10:03 pts/2    00:00:11 top -H -p 24977
[root@localhost ~]# 
```

3. 查看这个进程里，什么线程最消耗cpu资源
 ```bash
[root@localhost ~]# 
[root@localhost ~]# top -Hp 24977
top - 14:11:45 up 43 days, 16:13,  2 users,  load average: 0.04, 0.09, 0.07
Threads:  84 total,   0 running,  84 sleeping,   0 stopped,   0 zombie
%Cpu(s):  1.6 us,  1.6 sy,  0.0 ni, 96.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  8009268 total,  1261664 free,  3666564 used,  3081040 buff/cache
KiB Swap: 16777212 total, 16777212 free,        0 used.  3586364 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND                                                                                                               
24977 root      20   0 5724288 810948  13104 S  0.0 10.1   0:00.02 java                                                                                                                  
25031 root      20   0 5724288 810948  13104 S  0.0 10.1   0:08.85 java                                                                                                                  
25036 root      20   0 5724288 810948  13104 S  0.0 10.1   1:03.81 java                                                                                                                  
25037 root      20   0 5724288 810948  13104 S  0.0 10.1   0:53.00 java                                                                                                                  
25038 root      20   0 5724288 810948  13104 S  0.0 10.1   0:38.67 java                                                                                                                  
25039 root      20   0 5724288 810948  13104 S  0.0 10.1   0:44.57 java 
```

4. 通过 `top -Hp 24977` 查看到进程中最耗cpu的线程ID。通过 jstack 进程ID 命令查看线程具体信息

```bash
#  jstack命令使用16进制的线程id。
#  通过 printf "%x\n" 24977 命令转换为16进制线程ID
[root@localhost ~]# printf "%x\n" 24977
6191
[root@localhost ~]# 
[root@localhost ~]# jstack 24977

```

5. 如果是频繁GC导致cpu较高，可以使用 jmap -heap 24977 来查看堆内存情况

6. 导出堆栈信息
```bash
[root@localhost ~]#  jmap -dump:live,format=b,file=heap001  pid
[root@localhost ~]# 
[root@localhost ~]# 
# 将堆栈信息导出到文件，然后在文件中根据转换16进制后的线程ID进行查看
[root@localhost ~]#  jstack 线程ID >> aaaa.txt
```

```markdown
```
> 详细介绍了分析步骤

[cpu使用率飙高排查过程](https://my.oschina.net/u/2250599/blog/1505661)

[导出Java程序的内存堆栈信息](https://www.jianshu.com/p/0ab6ff2cba7f)

[CPU飙高，频繁GC，怎么排查](https://blog.csdn.net/youanyyou/article/details/102982429)